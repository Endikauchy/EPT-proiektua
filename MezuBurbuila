package txatapp;

import javax.swing.*;
import java.awt.*;
import java.time.LocalTime;
import java.time.format.DateTimeFormatter;

public class MezuBurbuila extends JPanel {
    private final String text;
    private final String time;
    private final boolean sentByMe;
    private final Color bubbleColor;
    private static final int ARC = 16;
    private static final int PADDING_X = 12;
    private static final int PADDING_Y = 3;
    private static final int MAX_WIDTH = 280;

    public MezuBurbuila(String text, boolean sentByMe) {
        this.text = text;
        this.sentByMe = sentByMe;
        this.time = LocalTime.now().format(DateTimeFormatter.ofPattern("HH:mm"));
        this.bubbleColor = sentByMe ? new Color(179, 229, 252) : new Color(240, 240, 240);

        setOpaque(false);
        setLayout(new BorderLayout());

        JLabel content = createContentLabel(text);
        JLabel ts = new JLabel(time);
        ts.setFont(ts.getFont().deriveFont(Font.PLAIN, 10f));
        ts.setForeground(new Color(100, 100, 100));

        JPanel inner = new JPanel(new BorderLayout());
        inner.setOpaque(false);
        inner.add(content, BorderLayout.CENTER);

        JPanel tsPanel = new JPanel(new FlowLayout(sentByMe ? FlowLayout.RIGHT : FlowLayout.LEFT, 0, 0));
        tsPanel.setOpaque(false);
        tsPanel.add(ts);
        inner.add(tsPanel, BorderLayout.SOUTH);

        inner.setBorder(BorderFactory.createEmptyBorder(PADDING_Y, PADDING_X, PADDING_Y, PADDING_X));
        add(inner, BorderLayout.CENTER);
    }

    private JLabel createContentLabel(String text) {
        String html = "<html><div style='width:" + (MAX_WIDTH - 2 * PADDING_X) + "px;'>" +
                escapeHtml(text).replace("\n", "<br/>") + "</div></html>";
        JLabel label = new JLabel(html);
        label.setFont(label.getFont().deriveFont(Font.PLAIN, 13f));
        label.setForeground(Color.DARK_GRAY);
        return label;
    }

    private String escapeHtml(String s) {
        return s.replace("&", "&amp;").replace("<", "&lt;").replace(">", "&gt;");
    }

    @Override
    public Dimension getPreferredSize() {
        Dimension pref = super.getPreferredSize();
        int w = Math.min(pref.width, MAX_WIDTH);
        return new Dimension(w, pref.height);
    }

    // Evita que el layout ensanche la burbuja más allá de su preferredSize
    @Override
    public Dimension getMaximumSize() {
        Dimension pref = getPreferredSize();
        // Permitir algo de margen vertical si lo deseas: usar pref.height + 2
        return new Dimension(pref.width, pref.height + 2);
    }



    @Override
    protected void paintComponent(Graphics g) {
        Graphics2D g2 = (Graphics2D) g.create();
        try {
            g2.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);

            int width = getWidth();
            int height = getHeight();
            int pad = 2;
            int rectWidth = width - pad * 2;
            int rectHeight = height - pad * 2;

            Color border = bubbleColor.darker();

            g2.setColor(new Color(0, 0, 0, 15));
            g2.fillRoundRect(pad + 1, pad + 2, rectWidth, rectHeight, ARC, ARC);

            g2.setColor(bubbleColor);
            g2.fillRoundRect(pad, pad, rectWidth, rectHeight, ARC, ARC);

            g2.setColor(new Color(border.getRed(), border.getGreen(), border.getBlue(), 120));
            g2.setStroke(new BasicStroke(1f));
            g2.drawRoundRect(pad, pad, rectWidth, rectHeight, ARC, ARC);
        } finally {
            g2.dispose();
        }
        super.paintComponent(g);
    }
}
