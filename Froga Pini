/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/Classes/Main.java to edit this template
 */
package p2pchat;

/**
 *
 * @author 
 */

import javax.swing.*;
import javax.swing.border.EmptyBorder;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.io.*;
import java.net.*;
import java.text.SimpleDateFormat;
import java.util.Date;

public class P2PChat extends JFrame {

    // --- GUI OSAGAIAK ---
    private JPanel chatPanel; // ORAIN: Panela da, ez testu eremua, burbuilak gehitzeko
    private JScrollPane chatScrollPane; // Scroll barra panela mugitzeko
    private JTextField messageInput;
    private JButton sendButton;
    private JList<String> contactList;
    
    // --- SAREKO OSAGAIAK ---
    private ServerSocket serverSocket;
    private Socket socket;
    private PrintWriter out;
    private BufferedReader in;

    // Main metodoa
    public static void main(String[] args) {
        SwingUtilities.invokeLater(() -> {
            try {
                P2PChat frame = new P2PChat();
                frame.setVisible(true);
                frame.setupConnection();
            } catch (Exception e) {
                e.printStackTrace();
            }
        });
    }

    // Eraikitzailea
    public P2PChat() {
        setTitle("Java P2P Chat - WhatsApp Style");
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setBounds(100, 100, 900, 600); // Leiho pixka bat handiagoa
        
        JPanel contentPane = new JPanel();
        contentPane.setBorder(new EmptyBorder(0, 0, 0, 0));
        contentPane.setLayout(new BorderLayout(0, 0));
        setContentPane(contentPane);

        // --- EZKERREKO ALDEA (KONTAKTUAK) ---
        DefaultListModel<String> listModel = new DefaultListModel<>();
        listModel.addElement("Laguna (Online)");
        listModel.addElement("Taldeko Lana");
        listModel.addElement("Ama");
        
        contactList = new JList<>(listModel);
        contactList.setBackground(new Color(245, 245, 245));
        contactList.setFixedCellHeight(50); // Kontaktuen altuera handitu itxura hobetzeko
        contactList.setSelectedIndex(0);
        
        JScrollPane leftScroll = new JScrollPane(contactList);
        leftScroll.setPreferredSize(new Dimension(220, 0));

        // --- ESKUINEKO ALDEA (TXATA) ---
        JPanel rightPanel = new JPanel();
        rightPanel.setLayout(new BorderLayout(0, 0));

        // 1. TXAT EREMUA (Berritasuna hemen dago)
        chatPanel = new JPanel();
        // BoxLayout erabiltzen dugu mezuak bata bestearen azpian jartzeko (Y_AXIS)
        chatPanel.setLayout(new BoxLayout(chatPanel, BoxLayout.Y_AXIS));
        chatPanel.setBackground(new Color(229, 221, 213)); // WhatsApp-eko atzeko kolore tipikoa
        
        // ScrollPane bat sortu, barruan gure chatPanela duena
        chatScrollPane = new JScrollPane(chatPanel);
        chatScrollPane.setHorizontalScrollBarPolicy(ScrollPaneConstants.HORIZONTAL_SCROLLBAR_NEVER); // Alboko scrolla kendu
        
        rightPanel.add(chatScrollPane, BorderLayout.CENTER);

        // 2. BEHEKO BARRA (Idazteko)
        JPanel inputPanel = new JPanel();
        inputPanel.setLayout(new BorderLayout());
        inputPanel.setBorder(new EmptyBorder(10, 10, 10, 10)); // Marjinak eman
        inputPanel.setBackground(new Color(240, 240, 240));
        
        messageInput = new JTextField();
        messageInput.setFont(new Font("SansSerif", Font.PLAIN, 16));
        
        sendButton = new JButton("Bidali");
        sendButton.setBackground(new Color(18, 140, 126)); // WhatsApp berde iluna
        sendButton.setForeground(Color.WHITE);
        sendButton.setFont(new Font("SansSerif", Font.BOLD, 14));
        
        inputPanel.add(messageInput, BorderLayout.CENTER);
        inputPanel.add(sendButton, BorderLayout.EAST);
        
        rightPanel.add(inputPanel, BorderLayout.SOUTH);

        // --- SPLIT PANE ---
        JSplitPane splitPane = new JSplitPane(JSplitPane.HORIZONTAL_SPLIT, leftScroll, rightPanel);
        splitPane.setDividerLocation(220);
        splitPane.setDividerSize(1);
        
        contentPane.add(splitPane, BorderLayout.CENTER);

        // --- EKINTZAK ---
        sendButton.addActionListener(e -> sendMessage());
        messageInput.addActionListener(e -> sendMessage());
    }

    // --- MEZUA PANTAILAN GEHITZEKO LOGIKA BERRIA ---
    
    /**
     * Metodo honek mezuaren "burbuila" sortzen du eta pantailan gehitzen du.
     * @param message Mezuaren testua
     * @param isMine  True bada nirea da (eskuina/berdea), False bada lagunarena (ezkerra/zuria)
     */
    private void addMessageToScreen(String message, boolean isMine) {
        SwingUtilities.invokeLater(() -> {
            // 1. Ilara bat sortu (Horizontal). Honek burbuila ezkerrean edo eskuinean bultzatuko du.
            JPanel rowPanel = new JPanel();
            rowPanel.setLayout(new BorderLayout());
            rowPanel.setOpaque(false); // Gardena, atzeko kolorea ikusteko
            rowPanel.setBorder(new EmptyBorder(5, 10, 5, 10)); // Espazioa mezuen artean

            // 2. Burbuila bera sortu (Mezua + Ordua)
            JPanel bubblePanel = new JPanel();
            bubblePanel.setLayout(new BorderLayout());
            // Kolorea aukeratu: Nirea (Berdea), Lagunarena (Zuria)
            bubblePanel.setBackground(isMine ? new Color(220, 248, 198) : Color.WHITE);
            // Ertz biribildua simulatzeko eta barne marjina emateko
            bubblePanel.setBorder(BorderFactory.createCompoundBorder(
                    BorderFactory.createLineBorder(new Color(200, 200, 200), 1), // Ertz fina
                    new EmptyBorder(8, 10, 5, 10) // Padding (barne espazioa)
            ));

            // 3. Testua gehitzea (HTML erabiltzen dugu zabalera mugatzeko eta saltoak egiteko)
            JLabel textLabel = new JLabel("<html><body style='width: 250px'>" + message + "</body></html>");
            textLabel.setFont(new Font("SansSerif", Font.PLAIN, 16));
            textLabel.setForeground(Color.BLACK);
            
            // 4. Ordua gehitzea
            String time = new SimpleDateFormat("HH:mm").format(new Date());
            JLabel timeLabel = new JLabel(time);
            timeLabel.setFont(new Font("SansSerif", Font.PLAIN, 10));
            timeLabel.setForeground(Color.GRAY);
            timeLabel.setHorizontalAlignment(SwingConstants.RIGHT); // Eskuinean lerrokatu

            // 5. Osagaiak burbuilan sartu
            bubblePanel.add(textLabel, BorderLayout.CENTER); // Testua erdian/goian
            bubblePanel.add(timeLabel, BorderLayout.SOUTH);  // Ordua behean

            // 6. Burbuila ilaran kokatu (Ezkerra edo Eskuina)
            JPanel bubbleWrapper = new JPanel(new FlowLayout(isMine ? FlowLayout.RIGHT : FlowLayout.LEFT));
            bubbleWrapper.setOpaque(false);
            bubbleWrapper.add(bubblePanel);
            
            rowPanel.add(bubbleWrapper, BorderLayout.CENTER);

            // 7. Panela pantailara gehitu
            chatPanel.add(rowPanel);
            
            // 8. Pantaila freskatu eta behera mugitu
            chatPanel.revalidate();
            chatPanel.repaint();
            
            // Scroll barra behera mugitu automatikoki
            SwingUtilities.invokeLater(() -> {
                JScrollBar vertical = chatScrollPane.getVerticalScrollBar();
                vertical.setValue(vertical.getMaximum());
            });
        });
    }

    // --- KONEXIO LOGIKA ---

    private void setupConnection() {
        Object[] options = {"Zerbitzaria izan", "Konektatu lagunari"};
        int choice = JOptionPane.showOptionDialog(this,
                "Nola konektatu nahi duzu?",
                "Konexioa",
                JOptionPane.YES_NO_OPTION,
                JOptionPane.QUESTION_MESSAGE,
                null,
                options,
                options[0]);

        if (choice == 0) { // Zerbitzaria
            new Thread(() -> {
                try {
                    // Mezua sistemaren abisu gisa gehitzen dugu (faltsututa, "isMine" false jarrita baina testuan abisua)
                    // Kasu honetan hobeto da System.out erabiltzea edo mezu berezi bat, 
                    // baina sinple egiteko pantailara botako dugu.
                    serverSocket = new ServerSocket(5000); 
                    SwingUtilities.invokeLater(() -> JOptionPane.showMessageDialog(this, "Zain 5000 portuan..."));
                    
                    socket = serverSocket.accept();
                    setupStreams();
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }).start();
        } else if (choice == 1) { // Bezeroa
            String ip = JOptionPane.showInputDialog(this, "Sartu IP helbidea:");
            if (ip != null && !ip.trim().isEmpty()) {
                new Thread(() -> {
                    try {
                        socket = new Socket(ip, 5000);
                        setupStreams();
                    } catch (IOException e) {
                        JOptionPane.showMessageDialog(this, "Errorea: " + e.getMessage());
                    }
                }).start();
            }
        }
    }

    private void setupStreams() throws IOException {
        out = new PrintWriter(socket.getOutputStream(), true);
        in = new BufferedReader(new InputStreamReader(socket.getInputStream()));

        new Thread(() -> {
            try {
                String inputLine;
                while ((inputLine = in.readLine()) != null) {
                    // LAGUNAREN MEZUA JASO (isMine = false)
                    addMessageToScreen(inputLine, false);
                }
            } catch (IOException e) {
                // Konexioa galtzen bada
            }
        }).start();
    }

    private void sendMessage() {
        String message = messageInput.getText();
        if (message != null && !message.trim().isEmpty()) {
            if (out != null) {
                out.println(message); // Sarean bidali
            }
            // NIRE MEZUA PANTILARATU (isMine = true)
            addMessageToScreen(message, true);
            messageInput.setText("");
        }
    }
}
