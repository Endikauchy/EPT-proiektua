/**

 * @author ENDIKA

 */

// Interfazea edo view-a



import javax.swing.*;

import javax.swing.text.*;

import java.awt.*;

import java.text.SimpleDateFormat;

import java.util.Date;

import java.net.InetAddress;



public class ChatSwing extends JFrame {

    private final JPanel chatPanel;

    private final JTextField inputField;

    private final JScrollPane scrollPane;

    private ChatController controller;

    private JLabel contactNameLabel;



    public ChatSwing() {

        // Configuración de la Ventana

        setTitle("TxatApp");

        setSize(400, 600);

        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);

        setLayout(new BorderLayout());



        // ----- Header -----

        JPanel header = new JPanel();

        header.setBackground(new Color(173, 216, 230));

        header.setPreferredSize(new Dimension(400, 50));

        header.setLayout(new FlowLayout(FlowLayout.LEFT, 15, 15));



        contactNameLabel = new JLabel("Esperando conexión...");

        contactNameLabel.setForeground(Color.WHITE);

        contactNameLabel.setFont(new Font("Arial", Font.BOLD, 20));

        header.add(contactNameLabel);



        add(header, BorderLayout.NORTH);



        // ----- Panel de mensajes -----

        chatPanel = new JPanel();

        chatPanel.setLayout(new BoxLayout(chatPanel, BoxLayout.Y_AXIS));

        chatPanel.setBackground(Color.WHITE);

        chatPanel.setBorder(BorderFactory.createEmptyBorder(10, 0, 0, 0));



        scrollPane = new JScrollPane(chatPanel);

        scrollPane.setBorder(null);

        add(scrollPane, BorderLayout.CENTER);



        // ----- Input -----

        JPanel inputPanel = new JPanel(new BorderLayout());

        inputPanel.setBackground(Color.WHITE);



        inputField = new JTextField();

        JButton sendButton = new JButton("Bidali");

        sendButton.setBackground(new Color(135, 206, 250));

        sendButton.setForeground(Color.WHITE);

        sendButton.setFocusPainted(false);



        inputPanel.add(inputField, BorderLayout.CENTER);

        inputPanel.add(sendButton, BorderLayout.EAST);

        inputPanel.setBorder(BorderFactory.createEmptyBorder(5, 5, 5, 5));



        add(inputPanel, BorderLayout.SOUTH);



        // ----- Eventos -----

        sendButton.addActionListener(e -> enviarDesdeControlador());

        inputField.addActionListener(e -> enviarDesdeControlador());



        setVisible(true);

    }



    public void setController(ChatController controller) {

        this.controller = controller;

    }



    private void enviarDesdeControlador() {

        if (controller == null) return;

        String text = inputField.getText();

        if (!text.isEmpty()) {

            controller.sendMessage(text);

            inputField.setText("");

        }

    }



    /**

     * Actualiza el nombre de usuario en el header (ejecutado en el EDT)

     */

    public void setContactName(String name) {

        SwingUtilities.invokeLater(() -> {

            contactNameLabel.setText(name);

        });

    }



    /**

     * Crear burbujas de mensaje con nombre, mensaje y hora al final

     */

    public void addMessageBubble(String sender, String message, boolean isUser) {

        final int maxWidth = 250;

        final int padding = 20; // Padding horizontal/vertical extra para la burbuja



        // Obtener hora actual

        String time = new SimpleDateFormat("HH:mm").format(new Date());



        // Burbuja

        JPanel bubble = new JPanel();

        

        Color bgColor;

        if (sender.equals("Sistema")) {

            bgColor = new Color(255, 255, 224);

        } else {

            bgColor = isUser ? new Color(220, 248, 198) : new Color(240, 240, 240);

        }

        

        bubble.setBackground(bgColor);

        bubble.setBorder(BorderFactory.createEmptyBorder(5, 10, 5, 10));

        bubble.setLayout(new BorderLayout());



        // JTextPane para el contenido

        // USAMOS JTextArea que gestiona mejor el ajuste de línea

        JTextArea msgArea = new JTextArea();

        msgArea.setEditable(false);

        msgArea.setOpaque(false);

        msgArea.setFont(new Font("Arial", Font.PLAIN, 14));

        msgArea.setLineWrap(true); // Activa el ajuste de línea

        msgArea.setWrapStyleWord(true); // Ajustar por palabras

        

        // --- Contenido y Estilos (Volvemos a un JTextArea simple para ajuste) ---

        

        String content;

        if (sender.equals("Sistema")) {

            content = message;

            msgArea.setFont(new Font("Arial", Font.ITALIC, 14)); // Itálica para sistema

        } else {

            // No podemos usar estilos negrita en JTextArea, así que simplificamos la visualización,

            // pero garantizamos el ajuste de línea (que era la prioridad).

            content = sender + " " + message + "  " + time;

        }

        

        msgArea.setText(content);



        // --- Cálculo Dinámico del Tamaño de la Burbuja ---

        

        // 1. Establecer ancho máximo para el área de texto

        msgArea.setSize(new Dimension(maxWidth, Short.MAX_VALUE));

        

        // 2. Calcular el tamaño preferido basado en el texto y el ancho máximo

        Dimension pref = msgArea.getPreferredSize();

        

        // El ancho final es el preferido (limitado a maxWidth), más el padding horizontal de la burbuja

        int finalWidth = Math.min(maxWidth, pref.width) + padding;

        int finalHeight = pref.height + padding - 5; // Ajuste de padding vertical



        bubble.add(msgArea, BorderLayout.CENTER);

        

        // 3. Aplicar el tamaño calculado a la burbuja

        bubble.setMaximumSize(new Dimension(finalWidth, finalHeight)); 

        bubble.setMinimumSize(new Dimension(finalWidth, finalHeight));

        bubble.setPreferredSize(new Dimension(finalWidth, finalHeight));

        

        // Wrapper alineado (centrado para Sistema, derecha para isUser, izquierda para Peer)

        JPanel wrapper = new JPanel();

        wrapper.setLayout(new BoxLayout(wrapper, BoxLayout.X_AXIS));

        wrapper.setBackground(Color.WHITE);

        wrapper.setBorder(BorderFactory.createEmptyBorder(0, 10, 0, 10));



        if (sender.equals("Sistema")) {

            wrapper.add(Box.createHorizontalGlue());

            wrapper.add(bubble);

            wrapper.add(Box.createHorizontalGlue());

        } else if (isUser) {

            wrapper.add(Box.createHorizontalGlue());

            wrapper.add(bubble);

        } else {

            wrapper.add(bubble);

            wrapper.add(Box.createHorizontalGlue());

        }



        chatPanel.add(wrapper);

        chatPanel.add(Box.createVerticalStrut(8));

        chatPanel.revalidate();

        chatPanel.repaint();



        // Scroll automático al final

        JScrollBar vertical = scrollPane.getVerticalScrollBar();

        vertical.setValue(vertical.getMaximum());

    }



    // Main

    public static void main(String[] args) {

        SwingUtilities.invokeLater(() -> {

            ChatSwing chatView = new ChatSwing();

            // Asumo que ChatControllerImpl existe en el classpath

            ChatController controller = new ChatControllerImpl(chatView);

            chatView.setController(controller);

        });

    }

}
